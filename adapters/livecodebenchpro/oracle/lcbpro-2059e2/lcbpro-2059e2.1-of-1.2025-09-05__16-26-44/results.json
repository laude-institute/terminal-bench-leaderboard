{
    "id": "e660039e-d8f6-4794-92d8-ad3e2cf36443",
    "trial_name": "lcbpro-2059e2.1-of-1.2025-09-05__16-26-44",
    "task_id": "lcbpro-2059e2",
    "instruction": "LiveCodeBench Pro (Mini) - external judge.\n\nThe agent must create a C++17 solution file at /app/main.cpp.\nThis task does not include local test cases. Instead, the test harness:\n  1) POSTs the code to the external judge (/submit) to get a sid,\n  2) polls GET /result/{sid}?short=1 until status == \"done\",\n  3) passes only if the judge returns passed == true.\n\nEnvironment variables (overridable at runtime):\n  - BASE_URL: judge base URL (default http://38.80.122.117:8081)\n  - PID: problem id (default 2059E2)\n  - LANG: language (default cpp)\n  - CODE_PATH: path to code (default /app/main.cpp)\n  - JUDGE_TIMEOUT_SECS: poll timeout seconds (default 120)\n\nThis is the hard version of the problem. The difference between the versions is that in this version you need to output all the operations that need to be performed. You can hack only if you solved all versions of this problem.\n\nYou are given $n$ arrays, each of which has a length of $m$. Let the $j$-th element of the $i$-th array be denoted as $a_{i, j}$. It is guaranteed that all $a_{i, j}$ are pairwise distinct. In one operation, you can do the following:\n\n- Choose some integer $i$ ($1 \\le i \\le n$) and an integer $x$ ($1 \\le x \\le 2 \\cdot n \\cdot m$).\n- For all integers $k$ from $i$ to $n$ in increasing order, do the following:\n1. Add the element $x$ to the beginning of the $k$-th array.\n\n2. Assign $x$ the value of the last element in the $k$-th array.\n\n3. Remove the last element from the $k$-th array.\n\nIn other words, you can insert an element at the beginning of any array, after which all elements in this and all following arrays are shifted by one to the right. The last element of the last array is removed.\n\nYou are also given a description of the arrays that need to be obtained after all operations. That is, after performing the operations, the $j$-th element of the $i$-th array should be equal to $b_{i, j}$. It is guaranteed that all $b_{i, j}$ are pairwise distinct.\n\nDetermine the minimum number of operations that need to be performed to obtain the desired arrays, and also output the sequence of all operations itself.\n\n### Input\n\nEach test consists of multiple test cases. The first line contains a single integer $t$ ($1 \\le t \\le 10^4$) -- the number of test cases. The description of the test cases follows.\n\nThe first line of each test case contains two integers $n$ and $m$ ($1 \\le n, m \\le 3 \\cdot 10^5$) -- the number of arrays and the number of elements in each array.\n\nThe $i$-th of the following $n$ lines contains $m$ integers $a_{i, 1}, a_{i, 2}, \\ldots, a_{i, m}$ ($1 \\le a_{i, j} \\le 2 \\cdot n \\cdot m$) -- the elements of the $i$-th original array. It is guaranteed that all $a_{i, j}$ are pairwise distinct.\n\nThe $i$-th of the following $n$ lines contains $m$ integers $b_{i, 1}, b_{i, 2}, \\ldots, b_{i, m}$ ($1 \\le b_{i, j} \\le 2 \\cdot n \\cdot m$) -- the elements of the $i$-th final array. It is guaranteed that all $b_{i, j}$ are pairwise distinct.\n\nIt is guaranteed that the sum of $n \\cdot m$ over all test cases does not exceed $3 \\cdot 10^5$.\n\n### Output\n\nFor each test case, output a single integer -- the minimum number of operations that need to be performed.\n\nNext, for each operation output two integers $i$ and $x$ ($1 \\le i \\le n$, $1 \\le x \\le 2 \\cdot n \\cdot m$) -- the index of the array where the element is inserted and the value of the element, respectively.\n\nIf there are multiple possible sequences with the minimum number of operations, output any of them.\n\n### Example\n\n#### Input #1\n\n```\n\n4\n\n2 2\n\n2 6\n\n3 4\n\n1 2\n\n7 8\n\n1 5\n\n5 4 1 2 3\n\n5 4 3 2 1\n\n3 3\n\n1 2 3\n\n4 5 6\n\n7 8 9\n\n11 1 2\n\n12 3 4\n\n13 5 6\n\n4 4\n\n1 2 3 4\n\n5 6 7 8\n\n9 10 11 12\n\n13 14 15 16\n\n17 1 2 3\n\n4 18 5 6\n\n7 19 8 20\n\n9 21 22 10\n\n```\n\n#### Output #1\n\n```\n3\n1 1\n2 8\n2 7\n5\n1 1\n1 2\n1 3\n1 4\n1 5\n3\n1 11\n2 12\n3 13\n6\n3 20\n2 18\n3 19\n4 22\n4 21\n1 17\n```\n\n### Note\n\nIn the first test case, the following sequence of $3$ operations is suitable:\n\n- Apply the operation to the first array with $x = 1$. Then the element $1$ will be added to the beginning of the first array, and the value of $x$ will become $6$. The last element will be removed, and the first array will look like $[1, 2]$. Next, the element $x$ is added to the beginning of the second array, and the value of $x$ becomes $4$. The last element of the second array is removed, and both arrays look like $[1, 2]$ and $[6, 3]$ respectively after the first operation.\n- Apply the operation to the second array with $x = 8$. Then the first array remains unchanged, and both arrays will look like $[1, 2]$ and $[8, 6]$ respectively.\n- Apply the operation to the second array with $x = 7$, then both arrays will have the required appearance $[1, 2]$ and $[7, 8]$ respectively.\n\nIn the second test case, the desired array can only be achieved in $5$ operations.\n\nIn the third test case, the following sequence of $3$ operations is suitable:\n\n- Apply the operation with $x = 11$ to the first array.\n- Apply the operation with $x = 12$ to the second array.\n- Apply the operation with $x = 13$ to the third array.",
    "is_resolved": true,
    "failure_mode": "unset",
    "parser_results": {
        "test_external_judge": "passed"
    },
    "recording_path": "2025-09-05__16-26-44/lcbpro-2059e2/lcbpro-2059e2.1-of-1.2025-09-05__16-26-44/sessions/agent.cast",
    "total_input_tokens": 0,
    "total_output_tokens": 0,
    "trial_started_at": "2025-09-05T23:36:53.358650+00:00",
    "trial_ended_at": "2025-09-05T23:37:55.081475+00:00",
    "agent_started_at": "2025-09-05T23:37:07.166737+00:00",
    "agent_ended_at": "2025-09-05T23:37:09.161623+00:00",
    "test_started_at": "2025-09-05T23:37:11.966312+00:00",
    "test_ended_at": "2025-09-05T23:37:41.326052+00:00"
}